FROM engine-room:os
LABEL maintainer="Jamil Andr√© RAICHOUNI <raichouni@gmail.com>"
ARG JDK_FILE
ARG WITH_OLLAMA=false
USER root

# use zsh for RUN commands {{{
SHELL ["/bin/zsh", "-c"]
ENV SHELL=/bin/zsh
# }}}

# Set ARCH environment variable once for all installations {{{
RUN ARCH="$(uname -m | sed -e 's/aarch64$/arm64/' -e 's/x86_64/amd64/')" && \
  echo "export ARCH=${ARCH}" >> /etc/environment && \
  echo "export ARCH=${ARCH}" >> /etc/zshenv
# }}}

# system pkg manager installs {{{
RUN dnf --refresh -y install \
  ImageMagick \
  lua5.1 \
  luarocks
# }}}

# uv setup and system python setup {{{
USER root
COPY dotfiles/requirements.txt /tmp
COPY dotfiles/uv.toml /etc/uv/uv.toml
ENV UV_CACHE_DIR=/mnt/volume/cache/uv
ENV UV_UNMANAGED_INSTALL=/usr/bin/
ENV UV_PYTHON_INSTALL_DIR=/opt/python
ENV UV_PYTHON_DOWNLOADS=auto
ENV _OLD_VIRTUAL_PATH="$PATH"
ENV VIRTUAL_ENV=/opt/.venv
ENV PATH="$VIRTUAL_ENV/bin:$PATH"
RUN curl -Lo /tmp/install.sh https://astral.sh/uv/install.sh && \
  chmod +x /tmp/install.sh && \
  UV_NO_MODIFY_PATH=1 sh /tmp/install.sh && \
  rm /tmp/install.sh && \
  uv python install --no-cache --default 3.14 && \
  uv venv --seed /opt/.venv && \
  chmod -R 777 /opt/.venv/bin && \
  chmod -R 777 /opt/.venv/lib/python*/site-packages && \
  chmod -R 777 /opt/python && \
  uv pip install -r /tmp/requirements.txt && \
  rm /tmp/requirements.txt && \
  rm /etc/uv/uv.toml
# }}}

# Recent Neovim {{{
USER root
WORKDIR /tmp
RUN curl -Lo /tmp/nvim-linux-arm64.tar.gz \
  https://github.com/neovim/neovim/releases/latest/download/nvim-linux-arm64.tar.gz && \
  tar xvzf /tmp/nvim-linux-arm64.tar.gz && \
  mv nvim-linux-arm64 /opt/nvim && \
  ln -s /opt/nvim/bin/nvim /usr/local/bin/nvim && \
  rm /tmp/nvim-linux-arm64.tar.gz
# Neovim needs Lua 5.1 (see checkhealth)
RUN rm /usr/bin/lua && ln -s /usr/bin/lua-5.1 /usr/bin/lua
WORKDIR /home/nerd
# }}}

# Recent JDK {{{
USER root
RUN mkdir -p /usr/lib/jvm
ADD build/${JDK_FILE}/ /usr/lib/jvm
RUN mv /usr/lib/jvm/jdk-* /usr/lib/jvm/jdk && \
  if [ -e /usr/bin/java ]; then mv /usr/bin/java /usr/bin/java.system; fi
# }}}

# GNU Privacy Guard (GnuPG) and Mozilla Secrets OPerationS (SOPS)" {{{
USER root
RUN mkdir -p /home/nerd/.gnupg/private-keys-v1.d && \
  chown -R $(id -u nerd):$(id -g nerd) /home/nerd/.gnupg && \
  chmod -R 700 /home/nerd/.gnupg && \
  dnf -y install \
  https://github.com/getsops/sops/releases/download/v3.11.0/sops-3.11.0-1.$(uname -m).rpm
# }}}

# kubectl {{{
USER root
RUN mkdir -p /home/nerd/.kube && \
  chown $(id -u nerd):$(id -g nerd) /home/nerd/.kube && \
  chmod 700 /home/nerd/.kube && \
  curl -LO \
  "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/arm64/kubectl" && \
  chmod +x kubectl && mv kubectl /opt && ln -s /opt/kubectl /usr/local/bin
# }}}

# krew {{{
USER nerd
WORKDIR /tmp
RUN set -x && \
  cd "$(mktemp -d)" && \
  OS="$(uname | tr '[:upper:]' '[:lower:]')" && \
  ARCH="$(uname -m | sed -e 's/x86_64/amd64/' -e 's/\(arm\)\(64\)\?.*/\1\2/' -e 's/aarch64$/arm64/')" && \
  KREW="krew-${OS}_${ARCH}" && \
  curl -fsSLO "https://github.com/kubernetes-sigs/krew/releases/latest/download/${KREW}.tar.gz" && \
  tar xvzf "${KREW}.tar.gz" && \
  ./"${KREW}" install krew
WORKDIR /home/nerd
# }}}

# tree-sitter {{{
USER root
WORKDIR /tmp
RUN source /etc/zshenv && \
  TREE_SITTER="tree-sitter-linux-${ARCH}" && \
  curl -fsSLO "https://github.com/tree-sitter/tree-sitter/releases/latest/download/${TREE_SITTER}.gz" && \
  gunzip tree-sitter-linux-*.gz && \
  mv ${TREE_SITTER} tree-sitter && \
  chmod +x tree-sitter && \
  mv tree-sitter /opt && \
  ln -s /opt/tree-sitter /usr/local/bin/tree-sitter
WORKDIR /home/nerd
# }}}

# kubectl plugin oidc-login {{{
USER nerd
RUN PATH=$HOME/.krew/bin:$PATH kubectl krew install oidc-login
# }}}

# oc - OpenShift Command Line Interface (CLI) {{{
USER root
COPY build/oc.tar /home/nerd
RUN tar -xvf oc.tar && \
  mv oc /opt && ln -s /opt/oc /usr/local/bin && \
  rm oc.tar
# }}}

# k3d and helm {{{
USER root
RUN curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash && \
  curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
# }}}

# act {{{
USER root
WORKDIR /tmp
RUN curl --proto '=https' --tlsv1.2 -sSf https://raw.githubusercontent.com/nektos/act/master/install.sh | sudo bash && \
  mv bin/act /opt && \
  rm -rf bin && \
  ln -s /opt/act /usr/local/bin
WORKDIR /home/nerd
# }}}

# OpenAPI Generator {{{
# see https://github.com/OpenAPITools/openapi-generator
USER root
RUN curl -Lo /opt/openapi-generator.jar \
  https://repo1.maven.org/maven2/org/openapitools/openapi-generator-cli/7.9.0/openapi-generator-cli-7.9.0.jar && \
  echo "java -jar /opt/openapi-generator.jar \$@" > /usr/local/bin/openapi-generator && \
  chmod +x /usr/local/bin/openapi-generator
# }}}

# nvm, node, npm, yarn and Node packages {{{
USER nerd
# https://github.com/nvm-sh/nvm/releases
RUN curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash
RUN touch /home/nerd/.zshrc && \
  zsh -c "source /home/nerd/.nvm/nvm.sh && nvm install --lts"

# npm pkgs
RUN zsh -c "source /home/nerd/.nvm/nvm.sh && \
  nvm use default && \
  npm install -g \
  @anthropic-ai/claude-code \
  @prettier/plugin-xml \
  gh-actions-language-server \
  markdownlint-cli \
  opencode-ai \
  prettier \
  prettier-plugin-jinja-template \
  prettier-plugin-sh \
  prettier-plugin-tailwindcss \
  prettier-plugin-toml \
  yarn"
# }}}

# hadolint (Dockerfile linter) {{{
USER root
RUN curl -Lo \
  /opt/hadolint https://github.com/hadolint/hadolint/releases/latest/download/hadolint-Linux-$(go env GOARCH) && \
  chmod +x /opt/hadolint && \
  ln -s /opt/hadolint /usr/local/bin/hadolint
# }}}

# ollama {{{
USER root
RUN if [ "$WITH_OLLAMA" = "true" ]; then \
  curl -fsSL https://ollama.com/install.sh | sh; \
  fi
# }}}

USER root
ENTRYPOINT ["python3", "/home/nerd/engine-room/supervisor.py"]
